from addict import Dict

SEVERITIES = ["LOW", "MODERATE", "HIGH", "CRITICAL"]


def get_max_severity(repo):
    max_severity_index = -1
    severity = "NONE"

    for va_edge in repo.vulnerabilityAlerts.edges:

        for v_edge in va_edge.node.securityAdvisory.vulnerabilities.edges:

            edge_severity = v_edge.node.severity
            severity_index = SEVERITIES.index(edge_severity)
            if severity_index > max_severity_index:
                max_severity_index = severity_index
                severity = edge_severity

    return severity


def group_by_severity(repositories):
    vulnerable_by_severity = Dict({sev: [] for sev in SEVERITIES})
    for repo in repositories:
        severity = get_max_severity(repo)
        vulnerable_by_severity[severity].append(repo)
    return vulnerable_by_severity
